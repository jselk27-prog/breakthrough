<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BreakFree ‚Äî AI Habit Recovery</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f1117;
      --surface: #161b27;
      --surface2: #1e2435;
      --border: #2a3048;
      --accent: #6b9fff;
      --accent2: #a0c4ff;
      --text: #e8edf8;
      --muted: #7a8aaa;
      --success: #6be8b0;
      --gold: #ffd166;
    }

    html, body {
      min-height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Nunito', sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
    }

    body::after {
      content: '';
      position: fixed;
      top: -200px;
      left: 50%;
      transform: translateX(-50%);
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(107,159,255,0.10) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    #app {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 20px 80px;
    }

    header {
      width: 100%;
      max-width: 700px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 28px 0 0;
    }

    .logo { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 1.4rem; letter-spacing: -0.02em; }
    .logo span { color: var(--accent); }

    .header-right { display: flex; align-items: center; gap: 10px; }

    .points-badge {
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--gold);
      background: rgba(255,209,102,0.1);
      border: 1px solid rgba(255,209,102,0.25);
      padding: 5px 14px;
      border-radius: 999px;
      display: none;
      align-items: center;
      gap: 6px;
    }

    .calls-badge {
      font-size: 0.75rem;
      color: var(--muted);
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 5px 12px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .calls-badge .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

    .hero {
      width: 100%;
      max-width: 700px;
      text-align: center;
      padding: 64px 0 48px;
      animation: fadeUp 0.7s ease both;
    }

    .hero-eyebrow {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 16px;
    }

    .hero h1 {
      font-family: 'Nunito', sans-serif;
      font-weight: 800;
      font-size: clamp(2.2rem, 6vw, 3.8rem);
      line-height: 1.08;
      letter-spacing: -0.03em;
      margin-bottom: 20px;
    }

    .hero h1 em { font-style: normal; color: var(--accent); }
    .hero p { color: var(--muted); font-size: 1.05rem; max-width: 480px; margin: 0 auto; }

    .card {
      width: 100%;
      max-width: 700px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 40px;
      animation: fadeUp 0.7s 0.15s ease both;
    }

    .card-title { font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 1.15rem; margin-bottom: 6px; }
    .card-sub { color: var(--muted); font-size: 0.88rem; margin-bottom: 32px; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group.full { grid-column: 1 / -1; }

    label {
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
    }

    input, select, textarea {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: 'Nunito', sans-serif;
      font-size: 0.95rem;
      padding: 12px 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
      width: 100%;
      appearance: none;
    }

    input::placeholder, textarea::placeholder { color: var(--muted); }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(107,159,255,0.12);
    }

    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237a8aaa' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
      cursor: pointer;
    }

    select option { background: var(--surface2); }
    textarea { resize: vertical; min-height: 80px; }

    /* Seriousness toggle */
    .seriousness-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .serious-option { display: none; }

    .serious-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 18px 12px;
      background: var(--surface2);
      border: 2px solid var(--border);
      border-radius: 14px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      text-align: center;
    }

    .serious-label:hover { border-color: var(--accent); background: rgba(107,159,255,0.06); }
    .serious-option:checked + .serious-label { border-color: var(--accent); background: rgba(107,159,255,0.1); }

    .serious-emoji { font-size: 1.6rem; }
    .serious-title { font-weight: 700; font-size: 0.95rem; }
    .serious-desc { font-size: 0.78rem; color: var(--muted); }

    .btn-primary {
      width: 100%;
      margin-top: 28px;
      padding: 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 12px;
      font-family: 'Nunito', sans-serif;
      font-weight: 800;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
    }

    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(107,159,255,0.35); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    .loading-screen {
      width: 100%;
      max-width: 700px;
      text-align: center;
      padding: 80px 20px;
      display: none;
      animation: fadeUp 0.5s ease both;
    }

    .loader {
      width: 48px; height: 48px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      margin: 0 auto 28px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-screen h2 { font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 1.4rem; margin-bottom: 10px; }
    .loading-screen p { color: var(--muted); font-size: 0.9rem; }

    .results-screen { width: 100%; max-width: 700px; display: none; animation: fadeUp 0.6s ease both; }

    .diagnosis-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 36px 40px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .diagnosis-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }

    .diagnosis-label { font-size: 0.7rem; font-weight: 600; letter-spacing: 0.16em; text-transform: uppercase; color: var(--accent); margin-bottom: 10px; }
    .diagnosis-title { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 1.8rem; letter-spacing: -0.02em; margin-bottom: 14px; }
    .diagnosis-text { color: var(--muted); font-size: 0.95rem; line-height: 1.7; }

    /* Points card */
    .points-card {
      background: var(--surface);
      border: 1px solid rgba(255,209,102,0.2);
      border-radius: 20px;
      padding: 28px 40px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .points-card-info h3 { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 1rem; margin-bottom: 3px; }
    .points-card-info p { font-size: 0.82rem; color: var(--muted); }

    .points-big { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 2.8rem; color: var(--gold); line-height: 1; text-align: right; }
    .points-big span { display: block; font-size: 0.75rem; font-weight: 600; color: var(--muted); }

    /* Daily card */
    .daily-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 36px 40px;
      margin-bottom: 20px;
    }

    .daily-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 8px; gap: 16px; }
    .daily-meta { display: flex; flex-direction: column; gap: 4px; }

    .week-tag { font-size: 0.68rem; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--accent); }
    .day-title { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 1.5rem; letter-spacing: -0.02em; }

    .day-points-today { text-align: right; flex-shrink: 0; }
    .day-points-today .pts-num { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 1.8rem; color: var(--gold); line-height: 1; }
    .day-points-today .pts-label { font-size: 0.72rem; color: var(--muted); display: block; }

    .goals-list { margin-top: 24px; display: flex; flex-direction: column; gap: 12px; }

    .goal-item {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      padding: 16px 18px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      user-select: none;
    }

    .goal-item:hover { border-color: var(--accent); }
    .goal-item.completed { background: rgba(107,159,255,0.07); border-color: rgba(107,159,255,0.3); }

    .goal-checkbox {
      width: 22px; height: 22px;
      border: 2px solid var(--border);
      border-radius: 6px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 1px;
      transition: all 0.2s;
      font-size: 0.8rem;
    }

    .goal-item.completed .goal-checkbox { background: var(--accent); border-color: var(--accent); }
    .goal-text { font-size: 0.95rem; line-height: 1.5; color: var(--text); transition: color 0.2s; flex: 1; }
    .goal-item.completed .goal-text { color: var(--muted); text-decoration: line-through; }

    .goal-points { flex-shrink: 0; font-size: 0.78rem; font-weight: 700; color: var(--gold); opacity: 0; transition: opacity 0.3s; }
    .goal-item.completed .goal-points { opacity: 1; }

    .day-nav { display: flex; align-items: center; justify-content: space-between; margin-top: 28px; gap: 12px; }

    .btn-nav {
      padding: 12px 24px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      font-size: 0.88rem;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }

    .btn-nav:hover:not(:disabled) { border-color: var(--accent); background: rgba(107,159,255,0.08); }
    .btn-nav:disabled { opacity: 0.3; cursor: not-allowed; }

    .day-progress { font-size: 0.82rem; color: var(--muted); text-align: center; }
    .progress-bar-wrap { height: 4px; background: var(--border); border-radius: 999px; margin-top: 6px; width: 120px; }
    .progress-bar-fill { height: 100%; background: var(--accent); border-radius: 999px; transition: width 0.4s ease; }

    /* Lock in */
    .lockin-card {
      background: linear-gradient(135deg, rgba(107,159,255,0.08), rgba(160,196,255,0.04));
      border: 1px solid rgba(107,159,255,0.25);
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 20px;
      text-align: center;
    }

    .lockin-icon { font-size: 2.5rem; margin-bottom: 16px; }
    .lockin-card h2 { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 1.5rem; margin-bottom: 12px; }
    .commitment-text { color: var(--muted); font-size: 0.95rem; line-height: 1.7; margin-bottom: 28px; font-style: italic; }

    .lockin-input-row { display: flex; gap: 12px; max-width: 400px; margin: 0 auto; }
    .lockin-input-row input { flex: 1; text-align: center; font-weight: 600; }

    .btn-lockin {
      padding: 12px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      font-family: 'Nunito', sans-serif;
      font-weight: 800;
      font-size: 0.9rem;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.15s, box-shadow 0.15s;
    }

    .btn-lockin:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(107,159,255,0.35); }

    .locked-confirmation {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--success);
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      margin-top: 20px;
      animation: fadeUp 0.4s ease both;
    }

    /* Support */
    .support-card { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 36px 40px; margin-bottom: 20px; display: none; }
    .support-card h3 { font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 1.05rem; margin-bottom: 6px; }

    .chat-messages { min-height: 40px; margin-bottom: 16px; display: flex; flex-direction: column; gap: 10px; }

    .msg { padding: 12px 16px; border-radius: 12px; font-size: 0.92rem; line-height: 1.6; max-width: 90%; animation: fadeUp 0.3s ease both; }
    .msg.user { background: rgba(107,159,255,0.12); border: 1px solid rgba(107,159,255,0.2); align-self: flex-end; }
    .msg.ai { background: var(--surface2); border: 1px solid var(--border); align-self: flex-start; color: var(--muted); }

    .chat-input-row { display: flex; gap: 10px; }
    .chat-input-row input { flex: 1; }

    .btn-send {
      padding: 12px 20px;
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      white-space: nowrap;
    }

    .btn-send:hover:not(:disabled) { border-color: var(--accent); background: rgba(107,159,255,0.08); }
    .btn-send:disabled { opacity: 0.4; cursor: not-allowed; }
    .calls-warning { text-align: center; font-size: 0.8rem; color: var(--accent); margin-top: 8px; display: none; }

    .btn-reset {
      display: block;
      margin: 10px auto 0;
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 10px 24px;
      border-radius: 10px;
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .btn-reset:hover { border-color: var(--accent); color: var(--accent); }

    .error-msg {
      background: rgba(255,100,100,0.1);
      border: 1px solid rgba(255,100,100,0.3);
      border-radius: 10px;
      padding: 14px 18px;
      font-size: 0.88rem;
      color: #ff9a9a;
      margin-top: 16px;
      display: none;
    }

    @keyframes fadeUp { from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:translateY(0)} }
    @keyframes pointsPop { 0%{transform:scale(1)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
    .pop { animation: pointsPop 0.35s ease; }

    @media (max-width: 600px) {
      .card, .diagnosis-card, .daily-card, .lockin-card, .support-card, .points-card { padding: 24px 20px; }
      .form-grid { grid-template-columns: 1fr; }
      .lockin-input-row { flex-direction: column; }
      .hero h1 { font-size: 2.1rem; }
      .seriousness-group { grid-template-columns: 1fr; }
      .day-nav { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
<div id="app">

  <header>
    <div class="logo">Break<span>Free</span></div>
    <div class="header-right">
      <div class="points-badge" id="pointsBadge">‚≠ê <span id="headerPoints">0</span> pts</div>
      <div class="calls-badge">
        <div class="dot"></div>
        <span id="callsText">AI Ready</span>
      </div>
    </div>
  </header>

  <!-- FORM -->
  <section class="hero" id="heroSection">
    <div class="hero-eyebrow">AI Habit Recovery</div>
    <h1>Know your habit.<br/><em>Break it for good.</em></h1>
    <p>Answer a few honest questions. The AI will diagnose your habit and build a personalized 30-day plan ‚Äî one day at a time.</p>
  </section>

  <div class="card" id="formCard">
    <div class="card-title">Tell us about your habit</div>
    <div class="card-sub">Be honest ‚Äî the more detail you give, the better your plan.</div>

    <div class="form-grid">
      <div class="form-group">
        <label>First Name</label>
        <input type="text" id="name" placeholder="Your name"/>
      </div>
      <div class="form-group">
        <label>Age</label>
        <select id="age">
          <option value="" disabled selected>Select age</option>
          <option>13</option><option>14</option><option>15</option><option>16</option><option>17</option><option>18</option><option>19+</option>
        </select>
      </div>
      <div class="form-group full">
        <label>What is your biggest habit or addiction?</label>
        <select id="habit">
          <option value="" disabled selected>Choose one</option>
          <option>Social media (Instagram, TikTok, Snapchat)</option>
          <option>Gaming / video games</option>
          <option>YouTube / streaming</option>
          <option>My phone in general</option>
          <option>Junk food / snacking</option>
          <option>Vaping / nicotine</option>
          <option>Other</option>
        </select>
      </div>
      <div class="form-group full" id="otherGroup" style="display:none;">
        <label>Describe your habit</label>
        <input type="text" id="habitOther" placeholder="e.g. I can't stop checking Reddit..."/>
      </div>
      <div class="form-group">
        <label>How long has this been going on?</label>
        <select id="duration">
          <option value="" disabled selected>Select duration</option>
          <option>A few weeks</option><option>A few months</option><option>About a year</option><option>Multiple years</option>
        </select>
      </div>
      <div class="form-group">
        <label>How often does it happen?</label>
        <select id="frequency">
          <option value="" disabled selected>Select frequency</option>
          <option>A few times a week</option><option>Every day</option><option>Multiple times a day</option><option>Almost constantly</option>
        </select>
      </div>
      <div class="form-group full">
        <label>What triggers it?</label>
        <input type="text" id="trigger" placeholder="e.g. when I'm bored, right before bed, after school..."/>
      </div>
      <div class="form-group full">
        <label>How has it negatively affected your life?</label>
        <textarea id="impact" placeholder="e.g. it's hurting my grades, I stay up too late, I feel anxious without it..."></textarea>
      </div>
      <div class="form-group full">
        <label>Have you tried to stop before?</label>
        <input type="text" id="attempts" placeholder="e.g. I tried deleting the app but reinstalled it in a day..."/>
      </div>
      <div class="form-group full">
        <label>How serious are you about breaking this habit?</label>
        <div class="seriousness-group">
          <input type="radio" name="seriousness" id="seriousHigh" value="high" class="serious-option"/>
          <label for="seriousHigh" class="serious-label">
            <span class="serious-emoji">üî•</span>
            <span class="serious-title">I'm fully committed</span>
            <span class="serious-desc">I want a challenging, no-excuses plan</span>
          </label>
          <input type="radio" name="seriousness" id="seriousLow" value="low" class="serious-option"/>
          <label for="seriousLow" class="serious-label">
            <span class="serious-emoji">üå±</span>
            <span class="serious-title">Taking it step by step</span>
            <span class="serious-desc">I want a gentle, easygoing plan to start</span>
          </label>
        </div>
      </div>
    </div>

    <button class="btn-primary" onclick="handleSubmit()">Generate My 30-Day Plan ‚Üí</button>
    <div class="error-msg" id="errorMsg"></div>
  </div>

  <!-- LOADING -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loader"></div>
    <h2>Building your plan...</h2>
    <p>The AI is personalizing your 30-day recovery journey. Just a moment.</p>
  </div>

  <!-- RESULTS -->
  <div class="results-screen" id="resultsScreen">

    <div class="diagnosis-card">
      <div class="diagnosis-label">Your Diagnosis</div>
      <div class="diagnosis-title" id="diagnosisTitle">‚Äî</div>
      <div class="diagnosis-text" id="diagnosisText">‚Äî</div>
    </div>

    <div class="points-card">
      <div class="points-card-info">
        <h3>Your Points</h3>
        <p>5 pts per goal ¬∑ 15 pts max per day ¬∑ progress saves automatically</p>
      </div>
      <div class="points-big" id="totalPointsDisplay">0<span>total points</span></div>
    </div>

    <div class="daily-card">
      <div class="daily-header">
        <div class="daily-meta">
          <div class="week-tag" id="weekTag">Week 1</div>
          <div class="day-title" id="dayTitle">Day 1</div>
        </div>
        <div class="day-points-today">
          <div class="pts-num" id="todayPointsNum">0</div>
          <span class="pts-label">today's pts</span>
        </div>
      </div>

      <div class="goals-list" id="goalsList"></div>

      <div class="day-nav">
        <button class="btn-nav" id="prevBtn" onclick="changeDay(-1)" disabled>‚Üê Prev Day</button>
        <div class="day-progress">
          <div id="dayProgressText">Day 1 of 30</div>
          <div class="progress-bar-wrap" style="margin:6px auto 0">
            <div class="progress-bar-fill" id="progressFill" style="width:3.3%"></div>
          </div>
        </div>
        <button class="btn-nav" id="nextBtn" onclick="changeDay(1)">Next Day ‚Üí</button>
      </div>
    </div>

    <div class="lockin-card">
      <div class="lockin-icon">üîí</div>
      <h2>Ready to lock in?</h2>
      <div class="commitment-text" id="commitmentText">Loading...</div>
      <div class="lockin-input-row">
        <input type="text" id="lockinInput" placeholder="Type &quot;I'm in&quot; to commit"/>
        <button class="btn-lockin" onclick="handleLockin()">Lock In</button>
      </div>
      <div class="locked-confirmation" id="lockedConfirmation">‚úì &nbsp;You're locked in. Day 1 starts now.</div>
    </div>

    <div class="support-card" id="supportCard">
      <h3>Need support?</h3>
      <div class="card-sub" style="margin-bottom:16px;">Ask anything about your plan. <span id="supportCallsLeft"></span></div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-row">
        <input type="text" id="chatInput" placeholder="Ask a question about your plan..." onkeydown="if(event.key==='Enter') sendChat()"/>
        <button class="btn-send" id="sendBtn" onclick="sendChat()">Send</button>
      </div>
      <div class="calls-warning" id="callsWarning"></div>
    </div>

    <button class="btn-reset" onclick="resetApp()">Start Over</button>
  </div>

</div>
<script>
  const PROXY_URL     = 'https://us-central1-brophy-ai-api.cloudfunctions.net/brophyProxy';
  const STUDENT_EMAIL = 'jselk27@brophybroncos.org';
  const STORAGE_KEY   = 'breakfree_v2';

  let planDays = [];
  let progress = { currentDay: 0, totalPoints: 0, dayData: {} };
  let planContext = '';
  let chatHistory = [];
  let supportCallsUsed = 0;
  const MAX_SUPPORT_CALLS = 1;

  // ‚îÄ‚îÄ LOAD SAVED ‚îÄ‚îÄ
  function loadSaved() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return;
      const d = JSON.parse(saved);
      if (!d.planDays || d.planDays.length !== 30) return;
      planDays   = d.planDays;
      progress   = d.progress || { currentDay: 0, totalPoints: 0, dayData: {} };
      planContext = d.planContext || '';
      document.getElementById('heroSection').style.display = 'none';
      document.getElementById('formCard').style.display    = 'none';
      document.getElementById('resultsScreen').style.display = 'block';
      document.getElementById('diagnosisTitle').textContent = d.diagnosisTitle || '';
      document.getElementById('diagnosisText').textContent  = d.diagnosisText  || '';
      document.getElementById('commitmentText').textContent = d.commitmentStatement || '';
      document.getElementById('lockedConfirmation').style.display = 'flex';
      document.getElementById('lockinInput').disabled = true;
      document.getElementById('lockinInput').value    = "I'm in ‚úì";
      document.querySelector('.btn-lockin').disabled  = true;
      document.getElementById('supportCard').style.display = 'block';
      document.getElementById('pointsBadge').style.display = 'flex';
      updateSupportCallsDisplay();
      renderDay(progress.currentDay);
      updatePointsUI();
    } catch(e) { console.log('No saved data'); }
  }

  function saveProgress() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        planDays, progress, planContext,
        diagnosisTitle:       document.getElementById('diagnosisTitle').textContent,
        diagnosisText:        document.getElementById('diagnosisText').textContent,
        commitmentStatement:  document.getElementById('commitmentText').textContent,
      }));
    } catch(e) {}
  }

  document.getElementById('habit').addEventListener('change', function() {
    document.getElementById('otherGroup').style.display = this.value === 'Other' ? 'flex' : 'none';
  });

  // ‚îÄ‚îÄ PROXY ‚îÄ‚îÄ
  async function callProxy(messages, system = '') {
    const body = { messages, max_tokens: 1500 };
    if (system) body.system = system;
    const res = await fetch(PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-student-email': STUDENT_EMAIL },
      body: JSON.stringify(body)
    });
    if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error || `Error ${res.status}`); }
    const data = await res.json();
    if (data._brophy) {
      const r = data._brophy.callsRemaining;
      document.getElementById('callsText').textContent = `${r} calls left`;
      const dot = document.querySelector('.calls-badge .dot');
      if (r <= 5) dot.style.background = '#ffaa4d';
      if (r <= 2) dot.style.background = '#ff6b6b';
    }
    return data.content[0].text;
  }

  // ‚îÄ‚îÄ PARSE JSON ‚îÄ‚îÄ
  function parseJSON(raw) {
    let c = raw.replace(/```json|```/gi,'').trim();
    const m = c.match(/\{[\s\S]*\}/);
    if (m) c = m[0];
    // Sanitize: remove newlines and extra spaces inside JSON string values
    // Replace literal newlines inside quoted strings with a space
    c = c.replace(/"([^"]*)"/g, (match, inner) => {
      return '"' + inner.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim() + '"';
    });
    try { return JSON.parse(c); } catch(e) {
      let r = c.trimEnd();
      if (!r.endsWith('}')) {
        if ((r.match(/"/g)||[]).length % 2 !== 0) r += '"';
        r += '\n}';
      }
      return JSON.parse(r);
    }
  }

  // ‚îÄ‚îÄ BUILD 30 DAYS ‚îÄ‚îÄ
  function buildPlanDays(parsed) {
    const days = [];
    [
      { num:1, title: parsed.week1Title||'Week 1', goals: parsed.week1Goals||[] },
      { num:2, title: parsed.week2Title||'Week 2', goals: parsed.week2Goals||[] },
      { num:3, title: parsed.week3Title||'Week 3', goals: parsed.week3Goals||[] },
      { num:4, title: parsed.week4Title||'Week 4', goals: parsed.week4Goals||[] },
    ].forEach(w => {
      for (let d = 0; d < 7; d++) {
        days.push({
          weekNum: w.num, weekTitle: w.title,
          goals: [
            w.goals[d*3]   || 'Complete a healthy activity today.',
            w.goals[d*3+1] || 'Reflect on your progress so far.',
            w.goals[d*3+2] || 'Do something kind for yourself.',
          ]
        });
      }
    });
    return days;
  }

  // ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ
  async function handleSubmit() {
    const name       = document.getElementById('name').value.trim();
    const age        = document.getElementById('age').value;
    const habitRaw   = document.getElementById('habit').value;
    const habitOther = document.getElementById('habitOther').value.trim();
    const habit      = habitRaw === 'Other' ? (habitOther||'unspecified habit') : habitRaw;
    const duration   = document.getElementById('duration').value;
    const frequency  = document.getElementById('frequency').value;
    const trigger    = document.getElementById('trigger').value.trim();
    const impact     = document.getElementById('impact').value.trim();
    const attempts   = document.getElementById('attempts').value.trim();
    const sEl        = document.querySelector('input[name="seriousness"]:checked');
    const seriousness = sEl ? sEl.value : '';

    if (!name||!age||!habitRaw||!duration||!frequency||!seriousness) {
      showError('Please fill out all fields, including how serious you are.');
      return;
    }

    document.getElementById('formCard').style.display    = 'none';
    document.getElementById('heroSection').style.display = 'none';
    document.getElementById('loadingScreen').style.display = 'block';
    document.getElementById('errorMsg').style.display    = 'none';

    const tone = seriousness === 'high'
      ? 'The user is fully committed. Make goals challenging and direct.'
      : 'The user wants to ease in gently. Make goals encouraging and low-pressure.';

    const system = `You are BreakFree, an empathetic AI habit coach for teenagers. ${tone}
CRITICAL: Respond ONLY with a raw JSON object. No markdown, no backticks, no text before or after. Start with { end with }.`;

    const prompt = `Diagnose this teenager's habit and generate a 30-day recovery plan with 3 specific daily goals per day.

USER:
- Name: ${name}, Age: ${age}
- Habit: ${habit}, Duration: ${duration}, Frequency: ${frequency}
- Triggers: ${trigger||'not specified'}
- Impact: ${impact||'not specified'}
- Previous attempts: ${attempts||'none'}
- Commitment: ${seriousness === 'high' ? 'Fully committed, wants tough plan' : 'Gentle start, wants encouraging plan'}

Return ONLY this raw JSON (no markdown):
{
  "diagnosisTitle": "punchy name for their addiction pattern",
  "diagnosisText": "2 sentences on what is really going on psychologically. Direct and real.",
  "commitmentStatement": "One powerful sentence written directly to ${name} about breaking this habit.",
  "week1Title": "Week 1 theme",
  "week1Goals": ["goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal"],
  "week2Title": "Week 2 theme",
  "week2Goals": ["goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal"],
  "week3Title": "Week 3 theme",
  "week3Goals": ["goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal"],
  "week4Title": "Week 4 theme",
  "week4Goals": ["goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal","goal"]
}
Each array has exactly 21 strings (7 days x 3 goals). Each goal must be a single short string under 12 words with NO line breaks, NO newlines, NO special characters. Goals get harder each week. Make them personal to ${name}'s habit and triggers. CRITICAL: Every string in the array must be on one line with no line breaks inside strings.`;

    try {
      const raw    = await callProxy([{ role:'user', content: prompt }], system);
      const parsed = parseJSON(raw);

      planDays  = buildPlanDays(parsed);
      progress  = { currentDay: 0, totalPoints: 0, dayData: {} };
      planContext = `User: ${name}, Age: ${age}, Habit: ${habit}. Weeks: ${parsed.week1Title}, ${parsed.week2Title}, ${parsed.week3Title}, ${parsed.week4Title}.`;

      document.getElementById('diagnosisTitle').textContent = parsed.diagnosisTitle || 'Your Habit Pattern';
      document.getElementById('diagnosisText').textContent  = parsed.diagnosisText  || '';
      document.getElementById('commitmentText').textContent = parsed.commitmentStatement || '';

      document.getElementById('loadingScreen').style.display  = 'none';
      document.getElementById('resultsScreen').style.display  = 'block';
      document.getElementById('pointsBadge').style.display    = 'flex';

      renderDay(0);
      updatePointsUI();
      saveProgress();

    } catch(err) {
      document.getElementById('loadingScreen').style.display  = 'none';
      document.getElementById('heroSection').style.display    = 'block';
      document.getElementById('formCard').style.display       = 'block';
      showError(err.message || 'Something went wrong. Please try again.');
    }
  }

  // ‚îÄ‚îÄ RENDER DAY ‚îÄ‚îÄ
  function renderDay(index) {
    if (!planDays[index]) return;
    const day    = planDays[index];
    const dayNum = index + 1;
    document.getElementById('weekTag').textContent       = `${day.weekTitle} ¬∑ Week ${day.weekNum}`;
    document.getElementById('dayTitle').textContent      = `Day ${dayNum}`;
    document.getElementById('dayProgressText').textContent = `Day ${dayNum} of 30`;
    document.getElementById('progressFill').style.width  = `${(dayNum/30)*100}%`;
    document.getElementById('prevBtn').disabled = index === 0;
    document.getElementById('nextBtn').disabled = index === 29;

    const saved = progress.dayData[index] || { completed:[false,false,false], points:0 };
    const list  = document.getElementById('goalsList');
    list.innerHTML = '';

    day.goals.forEach((goal, gi) => {
      const done = saved.completed[gi] || false;
      const item = document.createElement('div');
      item.className = `goal-item${done?' completed':''}`;
      item.innerHTML = `
        <div class="goal-checkbox">${done ? '‚úì' : ''}</div>
        <div class="goal-text">${goal}</div>
        <div class="goal-points">+5 pts</div>`;
      item.addEventListener('click', () => toggleGoal(index, gi));
      list.appendChild(item);
    });

    const pts = (saved.completed.filter(Boolean).length) * 5;
    document.getElementById('todayPointsNum').textContent = pts;
  }

  function toggleGoal(dayIndex, goalIndex) {
    if (!progress.dayData[dayIndex])
      progress.dayData[dayIndex] = { completed:[false,false,false], points:0 };
    const d = progress.dayData[dayIndex];
    const was = d.completed[goalIndex];
    d.completed[goalIndex] = !was;
    progress.totalPoints += was ? -5 : 5;
    if (progress.totalPoints < 0) progress.totalPoints = 0;
    d.points = d.completed.filter(Boolean).length * 5;
    updatePointsUI();
    renderDay(dayIndex);
    saveProgress();
  }

  function updatePointsUI() {
    const pts = progress.totalPoints;
    document.getElementById('totalPointsDisplay').innerHTML = `${pts}<span>total points</span>`;
    document.getElementById('headerPoints').textContent = pts;
    const el = document.getElementById('totalPointsDisplay');
    el.classList.remove('pop');
    void el.offsetWidth;
    el.classList.add('pop');
  }

  function changeDay(dir) {
    const next = progress.currentDay + dir;
    if (next < 0 || next > 29) return;
    progress.currentDay = next;
    renderDay(next);
    saveProgress();
    document.querySelector('.daily-card').scrollIntoView({ behavior:'smooth', block:'start' });
  }

  // ‚îÄ‚îÄ LOCK IN ‚îÄ‚îÄ
  function handleLockin() {
    const val = document.getElementById('lockinInput').value.trim().toLowerCase().replace(/['']/g,"'");
    if (val === "i'm in" || val === "im in") {
      document.getElementById('lockedConfirmation').style.display = 'flex';
      document.getElementById('lockinInput').disabled = true;
      document.querySelector('.btn-lockin').disabled  = true;
      document.getElementById('lockinInput').value    = "I'm in ‚úì";
      setTimeout(() => {
        document.getElementById('supportCard').style.display = 'block';
        updateSupportCallsDisplay();
        document.getElementById('supportCard').scrollIntoView({ behavior:'smooth', block:'start' });
      }, 800);
      saveProgress();
    } else {
      document.getElementById('lockinInput').style.borderColor = 'var(--accent)';
      document.getElementById('lockinInput').placeholder = "Type exactly: I'm in";
      setTimeout(() => { document.getElementById('lockinInput').style.borderColor = ''; }, 1400);
    }
  }

  // ‚îÄ‚îÄ SUPPORT ‚îÄ‚îÄ
  function updateSupportCallsDisplay() {
    const r = MAX_SUPPORT_CALLS - supportCallsUsed;
    document.getElementById('supportCallsLeft').textContent =
      r > 0 ? `${r} support message${r===1?'':'s'} remaining.` : 'No support messages remaining.';
    if (r <= 0) {
      document.getElementById('chatInput').disabled = true;
      document.getElementById('sendBtn').disabled   = true;
      document.getElementById('callsWarning').style.display = 'block';
      document.getElementById('callsWarning').textContent   = "You've used your support message. Trust your plan ‚Äî you've got this.";
    }
  }

  async function sendChat() {
    const input = document.getElementById('chatInput');
    const msg   = input.value.trim();
    if (!msg || supportCallsUsed >= MAX_SUPPORT_CALLS) return;
    input.value = '';
    addMessage('user', msg);
    document.getElementById('sendBtn').disabled = true;
    chatHistory.push({ role:'user', content: msg });
    const system = `You are BreakFree, a supportive AI habit coach. Context: ${planContext}. Keep responses 3-5 sentences, warm, direct, actionable.`;
    try {
      const reply = await callProxy(chatHistory, system);
      chatHistory.push({ role:'assistant', content: reply });
      addMessage('ai', reply);
      supportCallsUsed++;
    } catch(e) {
      addMessage('ai', 'Something went wrong. Please try again.');
    } finally {
      document.getElementById('sendBtn').disabled = false;
      updateSupportCallsDisplay();
    }
  }

  function addMessage(role, text) {
    const el = document.createElement('div');
    el.className = `msg ${role}`;
    el.textContent = text;
    document.getElementById('chatMessages').appendChild(el);
    el.scrollIntoView({ behavior:'smooth', block:'nearest' });
  }

  // ‚îÄ‚îÄ RESET ‚îÄ‚îÄ
  function resetApp() {
    if (!confirm('This will clear your progress and start over. Are you sure?')) return;
    localStorage.removeItem(STORAGE_KEY);
    planDays=[]; progress={currentDay:0,totalPoints:0,dayData:{}}; chatHistory=[]; supportCallsUsed=0; planContext='';
    document.getElementById('resultsScreen').style.display  = 'none';
    document.getElementById('heroSection').style.display    = 'block';
    document.getElementById('formCard').style.display       = 'block';
    document.getElementById('lockedConfirmation').style.display = 'none';
    document.getElementById('lockinInput').disabled = false;
    document.getElementById('lockinInput').value    = '';
    document.querySelector('.btn-lockin').disabled  = false;
    document.getElementById('chatMessages').innerHTML = '';
    document.getElementById('supportCard').style.display    = 'none';
    document.getElementById('pointsBadge').style.display    = 'none';
    document.getElementById('totalPointsDisplay').innerHTML = '0<span>total points</span>';
    document.getElementById('headerPoints').textContent     = '0';
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.style.display = 'block';
  }

  loadSaved();
</script>
</body>
</html>
